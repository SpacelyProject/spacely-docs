# Creating a Memory Map

All of the firmware blocks in a firmware image are placed inside a memory address space. Each firmware block has a base address, and each register inside that block has an offset from that base address. In order for the Peary server to successfully locate these registers, we need to provide it a map of the locations of these registers.

To do this, first we will create a human-readable *mem_map.txt*, and then we will auto-generate a Peary Memory Map from that. 

## Creating mem_map.txt

Each firmware block in your design that has AXI-controllable registers will have a section in *mem_map.txt*.

If you are using blocks from the Spacely Caribou Common Blocks repo, just go to the README file for that block and scroll to the bottom. There you will find the mem_map.txt entry for that block, which you can directly copy into your mem_map.txt. All you have to do is change the (IP Base Address) to the address found in the Vivado Address Editor.

If you are using a custom firmware block, you will have to write its mem_map.txt entry yourself. The format is described in the following section.

## mem_map.txt Format

 The format of this file is as follows:

The base address of each block is specified by a line starting with "\*BASE". This base address is effective until the next "\*BASE" line. Base addresses for each block are set in the Vivado Address Editor. **To be compliant with Spacely-Caribou, base addresses should be in the range 0x4_0000_0000 to 0x4_FFFF_FFFF.**


```
*BASE (IP Base Address)
```

After the base address is specified, each register is defined using a line with the format below. 

**NOTE:** If you use the auto-generation process from a fw_description file as described above, you do **NOT** need to write these lines by hand. The last section of the autogenerated README.md file contains a memory map for your block, which can be copy-and-pasted into your mem_map.txt. In this case, you only need to do two things for each block:

1. Update the base address from Vivado as described above.
2. If you are using multiple instances of a block, update the register names with an instance-specific prefix to prevent having multiple registers in your memory map with the same name.

Register format:

```
(name),(address_offset),(bitmask),(readable?),(writeable?)
```

Where:
- Name = String name, which will be used to call the register in software. 
- address_offset = Offset in bytes relative to the base address.
- bitmask = Which bits of the 32b AXI word correspond to this register. For a 32-bit register: 0xFFFFFFFF. For a 1-bit register it might be 0x1 or 0x2 or 0x4.
- readable? = True if readable, else False
- writeable? = True if writeable, else False


## Auto-generating a Peary Memory Map

Once this file is written, run Spacely (it does not matter which ASIC Spacely is targeting) and type **gen_mem_map()** in the main Spacely shell. You will be prompted to open your *mem_map.txt*, and then Spacely will print a C++ memory map which may be copied directly into *SpacelyCaribouBasicDefaults.hpp*. See [Peary Devices Files](</spacely-caribou/test-software-design/Peary Device Files.md>)